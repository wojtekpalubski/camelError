<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="
	http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans.xsd
	http://camel.apache.org/schema/spring
	http://camel.apache.org/schema/spring/camel-spring.xsd"
>
    <bean class="pl.wpe.PlikWalidacjaProcesor"
          id="PlikWalidacjaProcesor"/>
    <bean class="pl.wpe.UzupelnijPlikProcesor"
          id="UzupelnijPlikProcesor"/>
    <bean class="pl.wpe.ZakonczRouteException"
          id="ZakonczRouteException"/>
    <bean class="pl.wpe.SplitAgregator"
          id="SplitAgregator"/>

    <camelContext id="CamelErrorContext" xmlns="http://camel.apache.org/schema/spring"
                  errorHandlerRef="DeadLetterErrorhandler">

        <errorHandler id="DeadLetterErrorhandler" type="DeadLetterChannel" deadLetterUri="file:dl"
                      useOriginalMessage="true">
            <redeliveryPolicy maximumRedeliveries="3" redeliveryDelay="1000"
                              retryAttemptedLogLevel="WARN"
                              backOffMultiplier="2" useExponentialBackOff="true"/>
        </errorHandler>

        <errorHandler id="ZwyklyErrorHandler">
            <redeliveryPolicy maximumRedeliveries="2" redeliveryDelay="1000"
                              retryAttemptedLogLevel="WARN"/>
        </errorHandler>

        <!--<onException>-->
        <!--<exception>java.lang.Exception</exception>-->
        <!--<handled>-->
        <!--<constant>true</constant>-->
        <!--</handled>-->
        <!--&lt;!&ndash;<to uri="direct:obslugaBledu"/>&ndash;&gt;-->
        <!--<to uri="log:przechwycono Exception"/>-->
        <!--</onException>-->

        <!--<onException>-->
        <!--<exception>pl.wpe.BlednyPlikException</exception>-->
        <!--<handled>-->
        <!--<constant>false</constant>-->
        <!--</handled>-->
        <!--<log message="Obsluga bednego pliku w kontekscie"/>-->
        <!--&lt;!&ndash;<to uri="direct:obslugaBledu"/>&ndash;&gt;-->
        <!--</onException>-->

        <route id="odczytPlikuRoute">
            <from uri="file:we?delay=5s"></from>
            <log message="Czytam plik: ${file:name}"/>
            <!--<log message="Uzupelniam plik ${file:name}"/>-->
            <!--<process ref="UzupelnijPlikProcesor"/>-->
            <to uri="direct:bladSplit"/>
        </route>

        <route>
            <from uri="direct:prostyBlad"/>
            <doTry>
                <log message="proba"/>
                <process ref="PlikWalidacjaProcesor"/>
                <log message="proba ok"/>
                <doCatch>
                    <exception>java.lang.Exception</exception>
                    <handled>
                        <constant>false</constant>
                    </handled>

                    <log message="Przechwycone wyjatek procesora"/>
                </doCatch>
            </doTry>
            <to uri="log:poBledzie"/>
        </route>

        <route id="bladSplit">
            <from uri="direct:bladSplit"/>
            <log message="splituje: ${body}"/>
            <split strategyRef="SplitAgregator">
                <tokenize token="\n"/>
                <doTry>
                    <log message="W splicie1: ${body}"/>
                    <!--<setBody>-->
                    <!--<simple>${property.CamelSplitIndex},${property.CamelSplitSize} - ${body}</simple>-->
                    <!--</setBody>-->
                    <process ref="PlikWalidacjaProcesor"/>
                    <log message="W splicie2: ${body}"/>
                    <doCatch>
                        <exception>java.lang.Exception</exception>
                        <handled>
                            <constant>false</constant>
                        </handled>

                        <log message="Przechwycone wyjatek procesora w plicie: ${exception}"/>
                    </doCatch>
                </doTry>
            </split>

            <log message="Body po powrocie ze splitu:\n ${body}"/>

        </route>


        <route id="walidacjaPlikuRoute" errorHandlerRef="ZwyklyErrorHandler">
            <from uri="direct:walidacjaPliku"/>
            <log message="Przetwarzam ${body}"/>
            <log message="Uzupelniam plik ${file:name}"/>
            <process ref="UzupelnijPlikProcesor"/>
            <log message="Waliduje plik ${file:name}"/>
            <process ref="PlikWalidacjaProcesor"/>
            <to uri="direct:zapisPliku"/>
        </route>

        <route id="splitPliku">
            <from uri="direct:splitPliku"/>
            <log message="splituje ${body}"/>
            <split strategyRef="SplitAgregator">
                <tokenize token="\n"/>
                <log message="W splicie1: ${body}"/>
                <setBody>
                    <simple>${property.CamelSplitIndex},${property.CamelSplitSize} - ${body}</simple>
                </setBody>
                <process ref="UzupelnijPlikProcesor"/>
                <log message="W splicie2: ${body}"/>
            </split>

            <log message="Body po splicie:\n ${body}"/>

        </route>

        <route id="zapisPlikuRoute">
            <from uri="direct:zapisPliku"/>
            <to uri="file:wy"/>
        </route>

        <route id="obslugaBleduRoute">
            <from uri="direct:obslugaBledu"/>
            <log message="routa Obsluga bledu ${exception}"/>
            <!--<throwException ref="Exception"/>-->
            <to uri="file:blad"/>
        </route>
    </camelContext>
</beans>